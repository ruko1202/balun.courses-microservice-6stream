
## Общие принципы

- **Автономность сервисов**: Каждый сервис владеет только своими данными и взаимодействует с другими сервисами исключительно через API.
- **Взаимодействие**: Сервисы общаются синхронно (REST/gRPC) и асинхронно (через брокер сообщений, например, Kafka или RabbitMQ).
- **Событийная модель**: Важные бизнес-события публикуются и потребляются сервисами для обеспечения согласованности.

---

## Взаимодействие и события

- **Асинхронное взаимодействие**:
    - **Через брокер сообщений (Kafka/RabbitMQ) для событий.**
        - *у меня не так много опыта при работе с брокерами сообщений. выбираю Kafka, т.к. часто встречается "опыт работы с Kafka" в вакансиях на разработчика*
    - **События (event-driven)**:
        - Регистрация пользователя → создание профиля, инициализация дружбы
        - Отправка заявки в друзья → уведомление
        - Принятие заявки → разрешение на чат
        - Новое сообщение → уведомление получателю

- **Синхронное взаимодействие**:
    - gRPC для запросов между сервисами
    - http для запросов в API Gatawey

- **Хранение данных**
    - sql: postgreSQL
        - *у меня больше всего опыта работы с ней*
    - nosql: Redis
        - *у меня больше всего опыта работы с ней*
        - в том числе для кеширования
    - S3
        - minio или любой облачный провайдер

### [helicopter view](helicopter view.png)

---

## Сервисы и их ответственность

| Сервис                   | Ответственность                   | Свои данные             | Внешние API/методы                                         | Публикует события                                | Потребляет события             | Взаимодействует с    |
| ------------------------ | --------------------------------- | ----------------------- | ---------------------------------------------------------- | ------------------------------------------------ | ------------------------------ | -------------------- |
| **Auth Service**         | Регистрация, логин, OAuth, токены | Users, Credentials      | POST /register, POST /login, POST /oauth                   | UserRegistered, UserLoggedIn                     |                                | User/Profile         |
| **User/Profile Service** | Профиль, никнейм, аватар, about   | Profiles                | GET/PUT /profile, GET /users?search=                       | ProfileUpdated                                   | UserRegistered                 | Auth, Friend, Media  |
| **Friend Service**       | Дружба, заявки, подтверждения     | FriendRequests, Friends | POST /request, POST /accept, POST /decline, DELETE /friend | FriendRequestSent, FriendAccepted, FriendRemoved | UserRegistered, ProfileUpdated | User, Chat           |
| **Chat/Message Service** | Сообщения, чаты                   | Chats, Messages         | POST /message, GET /messages                               | MessageSent                                      | FriendAccepted                 | Friend, Notification |
| **Notification Service** | Уведомления (push, email)         | Notifications           | POST /notify                                               | NotificationSent                                 | MessageSent, FriendRequestSent | User, Chat, Friend   |
| **Media Service**        | Хранение и выдача аватарок/файлов | Files (S3, etc)         | POST /upload, GET /file                                    | FileUploaded                                     |                                | User/Profile         |
| **API Gateway**          | Единая точка входа для клиентов   | -                       | /api/* (роутинг)                                           |                                                  |                                | Все сервисы          |

### Описание сервисов

#### 1. Auth Service

- **Данные**: Пользователи, пароли (хэши), OAuth-идентификаторы, refresh-токены.
- **API**:
    - `POST /register`
    - `POST /login`
    - `POST /oauth`
    - `POST /refresh-token`
- **Публикует события**:
    - `UserRegistered` (после успешной регистрации)
    - `UserLoggedIn`
- **Потребляет события**: —
- **Взаимодействует**:
    - User/Profile Service (создание профиля после регистрации)
- **Примечание**: Не хранит профиль пользователя, только технические данные для аутентификации.

---

#### 2. User/Profile Service

- **Данные**: Профили (nickname, about, avatar_url), уникальность никнейма.
- **API**:
    - `GET /profile`
    - `PUT /profile`
    - `GET /users?search=nickname`
- **Публикует события**:
    - `ProfileUpdated`
- **Потребляет события**:
    - `UserRegistered` (создаёт профиль)
- **Взаимодействует**:
    - Media Service (загрузка аватара)
    - Friend Service (для отображения информации о друзьях)
- **Примечание**: Только профиль, не занимается дружбой или сообщениями.

---

#### 3. Friend Service

- **Данные**: Заявки в друзья, список друзей, статусы заявок.
- **API**:
    - `POST /request` (отправить заявку)
    - `POST /accept`, `POST /decline` (принять/отклонить)
    - `DELETE /friend` (удалить друга)
    - `GET /friends` (список друзей и заявок)
- **Публикует события**:
    - `FriendRequestSent`
    - `FriendAccepted`
    - `FriendRemoved`
- **Потребляет события**:
    - `UserRegistered` (инициализация)
    - `ProfileUpdated` (для обновления информации о друзьях)
- **Взаимодействует**:
    - User/Profile Service (для отображения профилей)
    - Chat Service (разрешение на чат только между друзьями)
- **Примечание**: Владеет только своими таблицами, не лезет в профили или сообщения.

---

#### 4. Chat/Message Service

- **Данные**: Сообщения, чаты (1-1), статусы прочтения.
- **API**:
    - `POST /message` (отправить сообщение)
    - `GET /messages?user_id=...`
- **Публикует события**:
    - `MessageSent`
- **Потребляет события**:
    - `FriendAccepted` (разрешение на создание чата)
- **Взаимодействует**:
    - Friend Service (проверка дружбы)
    - Notification Service (уведомления о новых сообщениях)
- **Примечание**: Для масштабирования — хранение сообщений в отдельной базе, push через WebSocket и/или брокер сообщений (Kafka, RabbitMQ).

---

#### 5. Notification Service

- **Данные**: Уведомления (push, email, in-app).
- **API**:
    - `POST /notify`
- **Публикует события**:
    - `NotificationSent`
- **Потребляет события**:
    - `MessageSent`, `FriendRequestSent`, `FriendAccepted`
- **Взаимодействует**:
    - User/Profile Service (получатель)
- **Примечание**: Может быть расширен для разных каналов уведомлений (email, push, in-app).

---

#### 6. Media Service

- **Данные**: Файлы (аватарки, вложения), метаданные.
- **API**:
    - `POST /upload`
    - `GET /file/{id}`
- **Публикует события**:
    - `FileUploaded`
- **Потребляет события**: —
- **Взаимодействует**:
    - User/Profile Service (аватарки)
- **Примечание**: Использует объектное хранилище (например, S3).

---

#### 7. API Gateway

- **Данные**: Не хранит бизнес-данные.
- **API**:
    - `/api/*` (роутинг к нужному сервису)
- **Публикует события**: —
- **Потребляет события**: —
- **Взаимодействует**:
    - Все сервисы
- **Примечание**: Единая точка входа для клиентов, может реализовывать авторизацию, rate limiting, логирование.

---

## [Пример сценариев](use-cases.md)

